<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Science Hall</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 15px;
            color: white;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .controls.collapsed {
            padding: 15px 20px;
        }
        .controls-content {
            display: block;
        }
        .controls.collapsed .controls-content {
            display: none;
        }
        .controls h2 {
            margin-bottom: 15px;
            color: #00ff88;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: bold;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(-1px);
        }
        .info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 15px;
            color: #00ff88;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
        }
        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 15px;
            color: #ffaa00;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 170, 0, 0.3);
            box-shadow: 0 0 30px rgba(255, 170, 0, 0.2);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="controls collapsed" id="controlPanel">
        <button onclick="toggleControls()" style="background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); margin-bottom: 10px; width: 100%;">
            <span id="toggleIcon">‚ñ∂Ô∏è</span> <span id="toggleText">OPEN CONTROLS</span>
        </button>
        <div class="controls-content">
            <h2>üî¨ SCIENCE HALL CONTROLS</h2>
            <button id="btnLights" onclick="toggleLights()">üí° Hall Lights: ON</button>
            <button id="btnFans" onclick="toggleFans()">üåÄ Ventilation: ON</button>
            <button onclick="startReaction()">‚öóÔ∏è Chemical Reaction</button>
            <button id="btnMachine" onclick="toggleMachine()">‚öôÔ∏è Centrifuge: OFF</button>
            <button id="btnPlasma" onclick="activatePlasma()">‚ö° Plasma Ball: OFF</button>
            <button id="btnLaser" onclick="toggleLaser()">üî¥ Laser: OFF</button>
            <button id="btnElectrolysis" onclick="startElectrolysis()">üîã Electrolysis: OFF</button>
            <button id="btnMicroscope" onclick="toggleMicroscope()">üî¨ Microscope</button>
            <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.2);">
            <button onclick="toggleAllEquipment()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); font-size: 16px; padding: 15px 25px;">üî¥ ALL EQUIPMENT ON/OFF</button>
        </div>
    </div>
    <div class="info">
        <strong>üéÆ Controls:</strong><br>
        üñ±Ô∏è Drag: Rotate view<br>
        üîç Scroll: Zoom<br>
        ‚å®Ô∏è WASD: Move camera
    </div>
    <div class="stats">
        <strong>‚ö° LAB STATUS</strong><br>
        <span id="experiments">Experiments: 0</span><br>
        <span id="energy">Energy: 100%</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer;
        let labLights = [], fans = [], beakers = [], particles = [];
        let machine, boards = [], plasmaGroup, laser, microscope, electrolysisTank;
        let lightsOn = true, fansRunning = true, machineOn = false, plasmaBallActive = false;
        let laserActive = false, electrolysisActive = false;
        let experimentCount = 0;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let velocity = new THREE.Vector3();

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x0a0a1a, 20, 80);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 25);
            camera.lookAt(0, 5, 0);
            
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Enhanced Lighting System
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            scene.add(ambientLight);
            
            // Main hall ceiling lights (8 lights)
            for(let i = 0; i < 8; i++) {
                const light = new THREE.PointLight(0xffffff, 1.5, 30);
                light.position.set(
                    (i % 4) * 10 - 15,
                    12,
                    Math.floor(i / 4) * 20 - 10
                );
                light.castShadow = true;
                light.shadow.mapSize.width = 1024;
                light.shadow.mapSize.height = 1024;
                scene.add(light);
                labLights.push(light);
                
                // Modern LED panel
                const panelGeom = new THREE.BoxGeometry(1.5, 0.1, 1.5);
                const panelMat = new THREE.MeshStandardMaterial({ 
                    color: 0xffff99, 
                    emissive: 0xffff99,
                    emissiveIntensity: 1.5
                });
                const panel = new THREE.Mesh(panelGeom, panelMat);
                panel.position.copy(light.position);
                scene.add(panel);
            }

            // Spotlight accents
            for(let i = 0; i < 4; i++) {
                const spotlight = new THREE.SpotLight(0x00ffaa, 2, 20, Math.PI / 6);
                spotlight.position.set(
                    (i % 2) * 20 - 10,
                    12,
                    Math.floor(i / 2) * 20 - 10
                );
                spotlight.target.position.set(spotlight.position.x, 0, spotlight.position.z);
                spotlight.castShadow = true;
                scene.add(spotlight);
                scene.add(spotlight.target);
            }

            // Large Hall Floor with grid pattern
            const floorGeom = new THREE.PlaneGeometry(60, 60);
            const floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a2e,
                roughness: 0.7,
                metalness: 0.3
            });
            const floor = new THREE.Mesh(floorGeom, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Floor tiles with grid
            for(let x = -30; x <= 30; x += 3) {
                for(let z = -30; z <= 30; z += 3) {
                    const tile = new THREE.Mesh(
                        new THREE.PlaneGeometry(2.8, 2.8),
                        new THREE.MeshStandardMaterial({ 
                            color: (x + z) % 6 === 0 ? 0x2a2a3e : 0x1f1f2e,
                            roughness: 0.9
                        })
                    );
                    tile.rotation.x = -Math.PI / 2;
                    tile.position.set(x, 0.01, z);
                    tile.receiveShadow = true;
                    scene.add(tile);
                }
            }

            // Hall Walls
            const wallMat = new THREE.MeshStandardMaterial({ 
                color: 0x2a2a3e,
                roughness: 0.8
            });
            
            const backWall = new THREE.Mesh(new THREE.PlaneGeometry(60, 15), wallMat);
            backWall.position.set(0, 7.5, -30);
            backWall.receiveShadow = true;
            scene.add(backWall);

            const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(60, 15), wallMat);
            leftWall.rotation.y = Math.PI / 2;
            leftWall.position.set(-30, 7.5, 0);
            leftWall.receiveShadow = true;
            scene.add(leftWall);

            const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(60, 15), wallMat);
            rightWall.rotation.y = -Math.PI / 2;
            rightWall.position.set(30, 7.5, 0);
            rightWall.receiveShadow = true;
            scene.add(rightWall);

            // Multiple Lab Tables
            for(let i = 0; i < 3; i++) {
                createLabTable(-15 + i * 15, 0, i);
            }

            // Chemistry Station with beakers
            createChemistryStation(-15, 0);

            // Physics Station with equipment
            createPhysicsStation(0, 0);

            // Advanced Equipment Station
            createAdvancedStation(15, 0);

            // Whiteboards on back wall
            for(let i = 0; i < 3; i++) {
                createWhiteboard(-18 + i * 18, 6, -29.5, i);
            }

            // Ceiling Fans (4 large industrial fans)
            for(let i = 0; i < 4; i++) {
                const fanGroup = new THREE.Group();
                
                const fanBase = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.3, 0.5, 16),
                    new THREE.MeshStandardMaterial({ color: 0x2a2a2a, metalness: 0.8 })
                );
                fanGroup.add(fanBase);

                const bladeGroup = new THREE.Group();
                for(let j = 0; j < 4; j++) {
                    const blade = new THREE.Mesh(
                        new THREE.BoxGeometry(2.5, 0.08, 0.4),
                        new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.6 })
                    );
                    blade.rotation.y = (j * Math.PI * 2) / 4;
                    blade.castShadow = true;
                    bladeGroup.add(blade);
                }
                bladeGroup.position.y = -0.3;
                fanGroup.add(bladeGroup);

                fanGroup.position.set(
                    (i % 2) * 20 - 10,
                    13,
                    Math.floor(i / 2) * 20 - 10
                );
                scene.add(fanGroup);
                fans.push({ group: fanGroup, blades: bladeGroup, speed: 0 });
            }

            // Plasma Ball
            createPlasmaBall(0, 3, -15);

            // Laser Setup
            createLaser(-15, 2.5, -10);

            // Electrolysis Tank
            createElectrolysisTank(15, 2, -10);

            // Microscope
            createMicroscope(15, 2, 5);

            // Window panels on side walls with light coming through
            for(let i = 0; i < 3; i++) {
                const windowGeom = new THREE.PlaneGeometry(4, 6);
                const windowMat = new THREE.MeshStandardMaterial({ 
                    color: 0x88ccff,
                    transparent: true,
                    opacity: 0.4,
                    emissive: 0x88ccff,
                    emissiveIntensity: 0.3
                });
                const window1 = new THREE.Mesh(windowGeom, windowMat);
                window1.rotation.y = Math.PI / 2;
                window1.position.set(-29.9, 8, -15 + i * 15);
                scene.add(window1);
            }

            setupControls();
            animate();
        }

        function createLabTable(x, z, index) {
            const tableGeom = new THREE.BoxGeometry(12, 0.3, 4);
            const tableMat = new THREE.MeshStandardMaterial({ 
                color: index % 2 === 0 ? 0x3a3a4e : 0x4a4a5e,
                metalness: 0.6,
                roughness: 0.4
            });
            const table = new THREE.Mesh(tableGeom, tableMat);
            table.position.set(x, 2, z);
            table.castShadow = true;
            table.receiveShadow = true;
            scene.add(table);

            // Metal legs
            for(let i = 0; i < 4; i++) {
                const leg = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.12, 0.12, 2, 8),
                    new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.9 })
                );
                leg.position.set(
                    x + (i % 2) * 5.5 - 2.75,
                    1,
                    z + Math.floor(i / 2) * 3.5 - 1.75
                );
                leg.castShadow = true;
                scene.add(leg);
            }

            // Shelf under table
            const shelf = new THREE.Mesh(
                new THREE.BoxGeometry(11, 0.2, 3.5),
                tableMat
            );
            shelf.position.set(x, 0.8, z);
            shelf.castShadow = true;
            scene.add(shelf);
        }

        function createChemistryStation(x, z) {
            const beakerData = [
                { xOff: -4, color: 0x00ff88, label: 'H‚ÇÇO' },
                { xOff: -2, color: 0xff0066, label: 'HCl' },
                { xOff: 0, color: 0x00ccff, label: 'NaOH' },
                { xOff: 2, color: 0xffaa00, label: 'H‚ÇÇSO‚ÇÑ' },
                { xOff: 4, color: 0xff00ff, label: 'KMnO‚ÇÑ' }
            ];

            beakerData.forEach(data => {
                const beakerGroup = new THREE.Group();
                
                const beakerGeom = new THREE.CylinderGeometry(0.35, 0.35, 1, 16, 1, true);
                const beakerMat = new THREE.MeshPhysicalMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.25,
                    roughness: 0.1,
                    metalness: 0.1,
                    transmission: 0.95
                });
                const beaker = new THREE.Mesh(beakerGeom, beakerMat);
                beaker.castShadow = true;
                beakerGroup.add(beaker);

                const liquidGeom = new THREE.CylinderGeometry(0.33, 0.33, 0.7, 16);
                const liquidMat = new THREE.MeshPhysicalMaterial({ 
                    color: data.color,
                    transparent: true,
                    opacity: 0.7,
                    emissive: data.color,
                    emissiveIntensity: 0.3
                });
                const liquid = new THREE.Mesh(liquidGeom, liquidMat);
                liquid.position.y = -0.15;
                beakerGroup.add(liquid);

                beakerGroup.position.set(x + data.xOff, 2.65, z);
                scene.add(beakerGroup);
                beakers.push({ group: beakerGroup, liquid: liquid, color: data.color });
            });

            // Test tube rack
            const rack = new THREE.Mesh(
                new THREE.BoxGeometry(3, 0.3, 1),
                new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.8 })
            );
            rack.position.set(x, 2.3, z + 1.5);
            scene.add(rack);

            // Test tubes
            for(let i = 0; i < 6; i++) {
                const tube = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.08, 0.08, 0.8, 8),
                    new THREE.MeshPhysicalMaterial({
                        color: 0xffffff,
                        transparent: true,
                        opacity: 0.3,
                        transmission: 0.9
                    })
                );
                tube.position.set(x - 1 + i * 0.4, 2.9, z + 1.5);
                scene.add(tube);
            }
        }

        function createPhysicsStation(x, z) {
            // Centrifuge Machine
            const machineGroup = new THREE.Group();
            
            const machineBody = new THREE.Mesh(
                new THREE.BoxGeometry(2, 1.5, 2),
                new THREE.MeshStandardMaterial({ 
                    color: 0x555555,
                    metalness: 0.8,
                    roughness: 0.3
                })
            );
            machineBody.castShadow = true;
            machineGroup.add(machineBody);

            const rotor = new THREE.Mesh(
                new THREE.CylinderGeometry(0.6, 0.6, 0.15, 8),
                new THREE.MeshStandardMaterial({ 
                    color: 0xff3333,
                    metalness: 0.9,
                    emissive: 0xff3333,
                    emissiveIntensity: 0
                })
            );
            rotor.position.y = 0.85;
            machineGroup.add(rotor);

            // Control panel
            const panel = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 0.8, 0.1),
                new THREE.MeshStandardMaterial({ color: 0x222222 })
            );
            panel.position.set(0, 0.3, 1.05);
            machineGroup.add(panel);

            // LED indicators
            for(let i = 0; i < 3; i++) {
                const led = new THREE.Mesh(
                    new THREE.CircleGeometry(0.05, 16),
                    new THREE.MeshStandardMaterial({ 
                        color: i === 0 ? 0xff0000 : (i === 1 ? 0xffff00 : 0x00ff00),
                        emissive: i === 0 ? 0xff0000 : (i === 1 ? 0xffff00 : 0x00ff00),
                        emissiveIntensity: 0
                    })
                );
                led.position.set(-0.4 + i * 0.4, 0.5, 1.06);
                machineGroup.add(led);
            }

            machineGroup.position.set(x, 2.9, z);
            scene.add(machineGroup);
            machine = { group: machineGroup, rotor: rotor, leds: machineGroup.children.slice(-3), rotation: 0 };

            // Spring balance
            const balance = new THREE.Group();
            const hook = new THREE.Mesh(
                new THREE.CylinderGeometry(0.05, 0.05, 1.5, 8),
                new THREE.MeshStandardMaterial({ color: 0xaaaaaa, metalness: 0.9 })
            );
            balance.add(hook);
            
            const scale = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16),
                new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.7 })
            );
            scale.position.y = -0.8;
            balance.add(scale);
            
            balance.position.set(x + 4, 3.5, z + 1);
            scene.add(balance);
        }

        function createAdvancedStation(x, z) {
            // Computer workstation
            const monitor = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 1, 0.1),
                new THREE.MeshStandardMaterial({ color: 0x111111 })
            );
            monitor.position.set(x - 3, 2.8, z);
            scene.add(monitor);

            const screen = new THREE.Mesh(
                new THREE.PlaneGeometry(1.3, 0.8),
                new THREE.MeshStandardMaterial({ 
                    color: 0x00ff88,
                    emissive: 0x00ff88,
                    emissiveIntensity: 0.5
                })
            );
            screen.position.set(x - 3, 2.8, z + 0.06);
            scene.add(screen);

            // Storage cabinets
            for(let i = 0; i < 2; i++) {
                const cabinet = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 3, 1.5),
                    new THREE.MeshStandardMaterial({ 
                        color: 0x4a4a5e,
                        metalness: 0.5
                    })
                );
                cabinet.position.set(x + 3 + i * 2.5, 1.5, z - 1);
                cabinet.castShadow = true;
                scene.add(cabinet);
            }
        }

        function createWhiteboard(x, y, z, index) {
            const boardGeom = new THREE.PlaneGeometry(5, 3);
            const boardMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            const board = new THREE.Mesh(boardGeom, boardMat);
            board.position.set(x, y, z);
            scene.add(board);

            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 320;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 512, 320);
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 28px Arial';
            
            if(index === 0) {
                ctx.fillText('CHEMISTRY LAB', 140, 50);
                ctx.font = '22px Arial';
                ctx.fillText('2H‚ÇÇ + O‚ÇÇ ‚Üí 2H‚ÇÇO', 140, 120);
                ctx.fillText('NaCl + H‚ÇÇO ‚Üí Na‚Å∫ + Cl‚Åª', 90, 170);
                ctx.fillText('CH‚ÇÑ + 2O‚ÇÇ ‚Üí CO‚ÇÇ + 2H‚ÇÇO', 70, 220);
            } else if(index === 1) {
                ctx.fillText('PHYSICS LAB', 160, 50);
                ctx.font = '22px Arial';
                ctx.fillText('E = mc¬≤', 190, 120);
                ctx.fillText('F = ma', 200, 170);
                ctx.fillText('V = IR', 200, 220);
            } else {
                ctx.fillText('ADVANCED SCIENCE', 120, 50);
                ctx.font = '22px Arial';
                ctx.fillText('PV = nRT', 180, 120);
                ctx.fillText('ŒîG = ŒîH - TŒîS', 150, 170);
                ctx.fillText('Œª = h/p', 190, 220);
            }

            const boardTexture = new THREE.CanvasTexture(canvas);
            board.material.map = boardTexture;
            boards.push(board);
        }

        function createPlasmaBall(x, y, z) {
            plasmaGroup = new THREE.Group();
            
            const sphere = new THREE.Mesh(
                new THREE.SphereGeometry(0.8, 32, 32),
                new THREE.MeshPhysicalMaterial({
                    color: 0xff00ff,
                    transparent: true,
                    opacity: 0.3,
                    emissive: 0xff00ff,
                    emissiveIntensity: 0
                })
            );
            plasmaGroup.add(sphere);

            const base = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.7, 0.5, 16),
                new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.8 })
            );
            base.position.y = -1;
            plasmaGroup.add(base);

            plasmaGroup.position.set(x, y, z);
            scene.add(plasmaGroup);
        }

        function createLaser(x, y, z) {
            laser = new THREE.Group();
            
            const laserBody = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 1, 16),
                new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.9 })
            );
            laserBody.rotation.z = Math.PI / 2;
            laser.add(laserBody);

            const mount = new THREE.Mesh(
                new THREE.BoxGeometry(0.3, 0.3, 0.3),
                new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.8 })
            );
            laser.add(mount);

            laser.position.set(x, y, z);
            laser.userData.active = false;
            scene.add(laser);
        }

        function createElectrolysisTank(x, y, z) {
            electrolysisTank = new THREE.Group();
            
            const tank = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 1, 1),
                new THREE.MeshPhysicalMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.2,
                    transmission: 0.9
                })
            );
            electrolysisTank.add(tank);

            const water = new THREE.Mesh(
                new THREE.BoxGeometry(1.4, 0.8, 0.9),
                new THREE.MeshPhysicalMaterial({
                    color: 0x00aaff,
                    transparent: true,
                    opacity: 0.6
                })
            );
            water.position.y = -0.1;
            electrolysisTank.add(water);

            // Electrodes
            for(let i = 0; i < 2; i++) {
                const electrode = new THREE.Mesh(
                    new THREE.BoxGeometry(0.1, 0.7, 0.1),
                    new THREE.MeshStandardMaterial({ 
                        color: i === 0 ? 0xff0000 : 0x0000ff,
                        metalness: 0.9
                    })
                );
                electrode.position.set((i === 0 ? -0.4 : 0.4), -0.1, 0);
                electrolysisTank.add(electrode);
            }

            electrolysisTank.position.set(x, y, z);
            electrolysisTank.userData.active = false;
            scene.add(electrolysisTank);
        }

        function createMicroscope(x, y, z) {
            microscope = new THREE.Group();
            
            const base = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.6, 0.2, 16),
                new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.8 })
            );
            microscope.add(base);

            const arm = new THREE.Mesh(
                new THREE.CylinderGeometry(0.08, 0.08, 1.5, 8),
                new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.9 })
            );
            arm.position.y = 0.75;
            microscope.add(arm);

            const lens = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.2, 0.4, 16),
                new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.9 })
            );
            lens.position.y = 1.5;
            microscope.add(lens);

            const eyepiece = new THREE.Mesh(
                new THREE.CylinderGeometry(0.1, 0.1, 0.3, 16),
                new THREE.MeshStandardMaterial({ color: 0x666666, metalness: 0.7 })
            );
            eyepiece.position.set(-0.3, 1.3, 0);
            eyepiece.rotation.z = Math.PI / 4;
            microscope.add(eyepiece);

            microscope.position.set(x, y, z);
            scene.add(microscope);
        }

        function setupControls() {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            document.addEventListener('mousedown', (e) => {
                isDragging = true;
            });

            document.addEventListener('mousemove', (e) => {
                if(isDragging) {
                    const deltaX = e.offsetX - previousMousePosition.x;
                    const deltaY = e.offsetY - previousMousePosition.y;
                    
                    const radius = Math.sqrt(
                        camera.position.x * camera.position.x + 
                        camera.position.z * camera.position.z
                    );
                    
                    const angle = Math.atan2(camera.position.z, camera.position.x);
                    const newAngle = angle - deltaX * 0.005;
                    
                    camera.position.x = radius * Math.cos(newAngle);
                    camera.position.z = radius * Math.sin(newAngle);
                    camera.position.y = Math.max(3, camera.position.y - deltaY * 0.05);
                    
                    camera.lookAt(0, 5, 0);
                }
                previousMousePosition = { x: e.offsetX, y: e.offsetY };
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            document.addEventListener('wheel', (e) => {
                const delta = e.deltaY * 0.01;
                const direction = new THREE.Vector3();
                camera.getWorldDirection(direction);
                
                camera.position.x += direction.x * delta;
                camera.position.z += direction.z * delta;
                
                const distance = Math.sqrt(
                    camera.position.x * camera.position.x + 
                    camera.position.z * camera.position.z
                );
                
                if(distance < 5) {
                    camera.position.x = camera.position.x / distance * 5;
                    camera.position.z = camera.position.z / distance * 5;
                } else if(distance > 40) {
                    camera.position.x = camera.position.x / distance * 40;
                    camera.position.z = camera.position.z / distance * 40;
                }
            });

            document.addEventListener('keydown', (e) => {
                switch(e.key.toLowerCase()) {
                    case 'w': moveForward = true; break;
                    case 's': moveBackward = true; break;
                    case 'a': moveLeft = true; break;
                    case 'd': moveRight = true; break;
                }
            });

            document.addEventListener('keyup', (e) => {
                switch(e.key.toLowerCase()) {
                    case 'w': moveForward = false; break;
                    case 's': moveBackward = false; break;
                    case 'a': moveLeft = false; break;
                    case 'd': moveRight = false; break;
                }
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            // Camera movement with WASD
            const moveSpeed = 0.3;
            if(moveForward || moveBackward || moveLeft || moveRight) {
                const direction = new THREE.Vector3();
                camera.getWorldDirection(direction);
                direction.y = 0;
                direction.normalize();
                
                const right = new THREE.Vector3();
                right.crossVectors(camera.up, direction).normalize();
                
                if(moveForward) {
                    camera.position.x -= direction.x * moveSpeed;
                    camera.position.z -= direction.z * moveSpeed;
                }
                if(moveBackward) {
                    camera.position.x += direction.x * moveSpeed;
                    camera.position.z += direction.z * moveSpeed;
                }
                if(moveLeft) {
                    camera.position.x -= right.x * moveSpeed;
                    camera.position.z -= right.z * moveSpeed;
                }
                if(moveRight) {
                    camera.position.x += right.x * moveSpeed;
                    camera.position.z += right.z * moveSpeed;
                }
                
                camera.position.x = Math.max(-25, Math.min(25, camera.position.x));
                camera.position.z = Math.max(-25, Math.min(25, camera.position.z));
            }

            // Animate fans
            fans.forEach(fan => {
                if(fansRunning) {
                    fan.speed = Math.min(fan.speed + 0.02, 0.3);
                } else {
                    fan.speed = Math.max(fan.speed - 0.01, 0);
                }
                fan.blades.rotation.y += fan.speed;
            });

            // Animate machine
            if(machineOn) {
                machine.rotation += 0.15;
                machine.rotor.rotation.y = machine.rotation;
                machine.rotor.material.emissiveIntensity = 0.5;
                machine.leds.forEach((led, i) => {
                    led.material.emissiveIntensity = Math.sin(Date.now() * 0.005 + i) * 0.5 + 0.5;
                });
            } else {
                machine.rotor.material.emissiveIntensity = 0;
                machine.leds.forEach(led => {
                    led.material.emissiveIntensity = 0;
                });
            }

            // Plasma ball effect
            if(plasmaBallActive && plasmaGroup) {
                const intensity = Math.sin(Date.now() * 0.01) * 0.5 + 0.5;
                plasmaGroup.children[0].material.emissiveIntensity = intensity * 2;
                plasmaGroup.rotation.y += 0.01;
            }

            // Laser beam
            if(laserActive && laser && !laser.userData.beam) {
                const beamGeom = new THREE.CylinderGeometry(0.05, 0.05, 30, 8);
                const beamMat = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.6
                });
                const beam = new THREE.Mesh(beamGeom, beamMat);
                beam.rotation.z = Math.PI / 2;
                beam.position.x = 15;
                laser.add(beam);
                laser.userData.beam = beam;
            } else if(!laserActive && laser && laser.userData.beam) {
                laser.remove(laser.userData.beam);
                laser.userData.beam = null;
            }

            // Electrolysis bubbles
            if(electrolysisActive && electrolysisTank) {
                if(Math.random() > 0.7) {
                    const bubble = new THREE.Mesh(
                        new THREE.SphereGeometry(0.03, 8, 8),
                        new THREE.MeshBasicMaterial({ 
                            color: Math.random() > 0.5 ? 0xff9999 : 0x9999ff,
                            transparent: true,
                            opacity: 0.8
                        })
                    );
                    bubble.position.copy(electrolysisTank.position);
                    bubble.position.x += (Math.random() - 0.5) * 0.8;
                    bubble.position.y += -0.3;
                    bubble.position.z += (Math.random() - 0.5) * 0.8;
                    bubble.userData.velocity = 0.02;
                    scene.add(bubble);
                    particles.push(bubble);
                }
            }

            // Animate particles
            for(let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.position.y += particle.userData.velocity || 0.05;
                particle.material.opacity -= 0.01;
                
                if(particle.material.opacity <= 0 || particle.position.y > 15) {
                    scene.remove(particle);
                    particles.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        function toggleLights() {
            lightsOn = !lightsOn;
            labLights.forEach(light => {
                light.intensity = lightsOn ? 1.5 : 0.2;
            });
            document.getElementById('btnLights').textContent = 'üí° Hall Lights: ' + (lightsOn ? 'ON' : 'OFF');
        }

        function toggleFans() {
            fansRunning = !fansRunning;
            document.getElementById('btnFans').textContent = 'üåÄ Ventilation: ' + (fansRunning ? 'ON' : 'OFF');
        }

        function startReaction() {
            if(beakers.length === 0) return;
            
            experimentCount++;
            document.getElementById('experiments').textContent = 'Experiments: ' + experimentCount;
            
            const beaker = beakers[Math.floor(Math.random() * beakers.length)];
            
            // Create explosion of particles
            for(let i = 0; i < 50; i++) {
                const particleGeom = new THREE.SphereGeometry(0.08, 8, 8);
                const particleMat = new THREE.MeshBasicMaterial({ 
                    color: beaker.color,
                    transparent: true,
                    opacity: 1
                });
                const particle = new THREE.Mesh(particleGeom, particleMat);
                
                const angle = (Math.PI * 2 * i) / 50;
                const radius = 0.3;
                
                particle.position.copy(beaker.group.position);
                particle.userData.velocity = 0.08;
                particle.userData.velocityX = Math.cos(angle) * 0.05;
                particle.userData.velocityZ = Math.sin(angle) * 0.05;
                
                scene.add(particle);
                particles.push(particle);
            }

            // Color change animation
            const originalColor = beaker.liquid.material.color.clone();
            const newColor = new THREE.Color(Math.random(), Math.random(), Math.random());
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 0.05;
                beaker.liquid.material.color.lerpColors(originalColor, newColor, progress);
                beaker.liquid.material.emissive.copy(beaker.liquid.material.color);
                
                if(progress >= 1) {
                    clearInterval(interval);
                    beaker.color = newColor.getHex();
                }
            }, 50);
        }

        function toggleMachine() {
            machineOn = !machineOn;
            document.getElementById('btnMachine').textContent = '‚öôÔ∏è Centrifuge: ' + (machineOn ? 'ON' : 'OFF');
        }

        function activatePlasma() {
            plasmaBallActive = !plasmaBallActive;
            document.getElementById('btnPlasma').textContent = '‚ö° Plasma Ball: ' + (plasmaBallActive ? 'ON' : 'OFF');
            if(plasmaBallActive) {
                experimentCount++;
                document.getElementById('experiments').textContent = 'Experiments: ' + experimentCount;
            }
        }

        function toggleLaser() {
            laserActive = !laserActive;
            document.getElementById('btnLaser').textContent = 'üî¥ Laser: ' + (laserActive ? 'ON' : 'OFF');
            if(laserActive) {
                experimentCount++;
                document.getElementById('experiments').textContent = 'Experiments: ' + experimentCount;
            }
        }

        function startElectrolysis() {
            electrolysisActive = !electrolysisActive;
            document.getElementById('btnElectrolysis').textContent = 'üîã Electrolysis: ' + (electrolysisActive ? 'ON' : 'OFF');
            if(electrolysisActive) {
                experimentCount++;
                document.getElementById('experiments').textContent = 'Experiments: ' + experimentCount;
            }
        }

        function toggleMicroscope() {
            if(microscope) {
                microscope.rotation.y += Math.PI / 4;
                experimentCount++;
                document.getElementById('experiments').textContent = 'Experiments: ' + experimentCount;
            }
        }

        function toggleAllEquipment() {
            const allOn = machineOn || plasmaBallActive || laserActive || electrolysisActive;
            
            if(allOn) {
                // Turn everything OFF
                if(machineOn) toggleMachine();
                if(plasmaBallActive) activatePlasma();
                if(laserActive) toggleLaser();
                if(electrolysisActive) startElectrolysis();
                if(!fansRunning) toggleFans();
                if(!lightsOn) toggleLights();
            } else {
                // Turn everything ON
                if(!machineOn) toggleMachine();
                if(!plasmaBallActive) activatePlasma();
                if(!laserActive) toggleLaser();
                if(!electrolysisActive) startElectrolysis();
                if(!fansRunning) toggleFans();
                if(!lightsOn) toggleLights();
            }
        }

        function toggleControls() {
            const panel = document.getElementById('controlPanel');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            if(panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                icon.textContent = 'üîΩ';
                text.textContent = 'CLOSE CONTROLS';
            } else {
                panel.classList.add('collapsed');
                icon.textContent = '‚ñ∂Ô∏è';
                text.textContent = 'OPEN CONTROLS';
            }
        }

        init();
    </script>
</body>
</html>